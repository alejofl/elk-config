# Instalar ELK in Windows

Para poder obtener logs de Windows con ELK se incorpora a Winlogbeat, un componente que forma parte del stack de Elastic y facilita la manera en la que se realiza esta tarea.

Para cada componente que veremos a continuación estaremos trabajando en la carpeta `C:\program-version-number`.

> [!NOTE]  
> Para nuestra configuración en AWS solamente se necesitaron los apartados de **Instalando `winlogbeat`** e **Instalando `logstash`**. Los otros dos fueron realizados en instancias EC2 Ubuntu y por eso en este documento solamente se muestra la configuración de los mismos en el ambiente local.

## Instalando `elasticsearch`

1. Descargamos `elasticsearch` de la página:
    
    [Install Elasticsearch with .zip on Windows | Elasticsearch Guide [8.13] | Elastic](https://www.elastic.co/guide/en/elasticsearch/reference/8.13/zip-windows.html)
    
2. Descomprimimos el archivo `.zip` que descargamos e ingresamos en la carpeta correspondiente. En nuestro caso ingresaremos a `C:\elasticsearch-8.13.4`.
3. Abirmos una terminal como administradores e ingresamos a la carpeta `C:\elasticsearch-8.13.4\bin`.
    
    ```bash
    >> cd bin
    ```
    
4. Corremos en la terminal el archivo `.\elasticsearch.bat` para poder instalarlo:
    
    ```bash
    >> .\elasticsearch.bat
    ```
    
5. Abrimos otra terminal también como administradores, ingresamos a la carpeta `C:\elasticsearch-8.13.4\bin` y corremos el siguiente comando:
    
    ```bash
    >> .\elasticsearch-users useradd johndoe -r superuser
    ```
    
    Esto crea un nuevo usuario y contraseña y es lo que nos permitirá ingresar a `kibana` más adelante con los siguientes datos:
    
    - User: `johndoe`
    - Password: `123456`

## Instalando `kibana`

1. Descargamos `kibana` de la página:
    
    [Install Kibana on Windows | Kibana Guide [8.13] | Elastic](https://www.elastic.co/guide/en/kibana/current/windows.html#windows-enroll)
    
2. Descomprimimos el archivo `.zip` que nos descargo y después ingresamos a la carpeta `C:\kibana-8.13.4`
3. Antes de continuar con `kibana` debemos ir a la carpeta donde se encuentra el archivo `elasticsearch-reset-password.bat` (en nuestro caso se encuentra en `C:\elasticsearch-8.13.4\bin\elasticsearch-reset-password.bat`) y abrimos una terminal como administrador para correr el siguiente comando:
    
    ```bash
    >> cd elasticsearch-8.13.4\bin
    >> .\elasticsearch-reset-password.bat -u kibana_system --auto
    warning: ignoring JAVA_HOME=C:\Users\nehue\.jdks\openjdk-20.0.2; using bundled JDK
    This tool will reset the password of the [kibana_system] user to an autogenerated value.
    The password will be printed in the console.
    Please confirm that you would like to continue [y/N]y
    
    Password for the [kibana_system] user successfully reset.
    New value: 6=ODDsGRMseRebDp1W2F
    ```
    
    Obtendremos la contraseña del usuario `kibana_system` que nos ayudará más adelante.
    
4. Ingresamos al archivo `kibana.yml`presente en la carpeta `C:\elasticsearch-8.13.4\config`. Una vez en él descomentaremos las líneas del `elasticsearch.username` y `elasticsearch.password`:
    
    ```bash
    # If your Elasticsearch is protected with basic authentication, these settings provide
    # the username and password that the Kibana server uses to perform maintenance on the Kibana
    # index at startup. Your Kibana users still need to authenticate with Elasticsearch, which
    # is proxied through the Kibana server.
    elasticsearch.username: "kibana_system"
    elasticsearch.password: "6=ODDsGRMseRebDp1W2F"
    ```
    
5. Abrimos una terminal como administradores y nos situamos en la carpeta de `kibana` (`C:\kiabana-8.13.4`) para correr el siguiente comando e instalar Kibana.
    
    ```bash
    >> .\bin\kibana.bat
    ```
    
6. Ingresamos a [localhost:5601](https://localhost:5601) e ingresamos con el siguiente usuario y contraseña para chequear que todo este correctamente instalado:
    - User: `johndoe`
    - Password: `123456`

## Instalando `winlogbeat`

1. Descargamos de la página el `.zip` de `winlogbeat`
    
    [Winlogbeat quick start: installation and configuration | Winlogbeat Reference [8.13] | Elastic](https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation-configuration.html)
    
2. Descomprimimos el archivo `.zip` y lo ubicamos en la carpeta que queramos.
3. Abrimos una terminal como administrador, nos ubicamos en la carpeta de `winlogbeat` `C:\winlogbeat` y corremos `.\install-service-winlogbeat.ps1`
    
    ```bash
    C:\winlogbeat> .\install-service-winlogbeat.ps1
    Security warning
    Run only scripts that you trust. While scripts from the internet can be useful,
    this script can potentially harm your computer. If you trust this script, use
    the Unblock-File cmdlet to allow the script to run without this warning message.
    Do you want to run C:\Program Files\Winlogbeat\install-service-winlogbeat.ps1?
    [D] Do not run  [R] Run once  [S] Suspend  [?] Help (default is "D"): R
    
    Status   Name               DisplayName
    ------   ----               -----------
    Stopped  winlogbeat         winlogbeat
    ```
    
    Si no funciona intenta esto:
    
    ```bash
    C:\winlogbeat> powershell -ExecutionPolicy Bypass -File .\install-service-winlogbeat.ps1
    ```
    
4. Configuramos a `winlogbeat` para que pueda conectarse con EK en el archivo `winlogbeat.yml` que se encuentra en `C:\winlogbeat`:
    
    <aside>
    
    **Leer en el siguiente link las configuraciones para poder obtener logs de diferentes tipos. Con la configuración actual solamente obtendremos los logs de aplicaciones y los de seguridad.**
    
    [Configure Winlogbeat | Winlogbeat Reference [8.13] | Elastic](https://www.elastic.co/guide/en/beats/winlogbeat/current/configuration-winlogbeat-options.html)
    
    </aside>
    
    En el apartado de specific options especificamos los `event_logs` que queremos catchear:
    
    ```bash
      # ======================== Winlogbeat specific options =========================

      winlogbeat.event_logs:
        - name: Application
          ignore_older: 72h

        - name: System

        - name: Security

        - name: Microsoft-Windows-Sysmon/Operational

        - name: Windows PowerShell
          event_id: 400, 403, 600, 800

        - name: Microsoft-Windows-PowerShell/Operational
          event_id: 4103, 4104, 4105, 4106

        - name: ForwardedEvents
          tags: [forwarded]
    ```
    
    En el apartado de outputs especificamos a dónde es que enviaremos los `event_logs` catcheados:
    
    ```bash
      # ================================== Outputs ===================================
    
      # ------------------------------ Logstash Output -------------------------------
      output.logstash:
        # The Logstash hosts
        hosts: ["localhost:5044"]
    ```
    
    En el apartado de Logging especificamos lo siguiente que sirve para poder crear archivos de logs en la carpeta correspondiente:
    
    ```bash
    # ================================== Logging ===================================
    
    logging.to_files: true
    logging.files:
      path: C:\winlogbeat\logs
    logging.level: info
    ```
    
5. En la terminal que habíamos abierto previamente como administradores, corremos el siguiente comando para testear que el archivo de configuración esté correctamente formado:
    
    ```bash
    C:\winlogbeat> .\winlogbeat.exe test config -c .\winlogbeat.yml -e
    ```
    
    Nos tiene que devolver:
    
    ```bash
    C:\winlogbeat> .\winlogbeat.exe test config -c .\winlogbeat.yml -e
    ...
    Config OK
    ```
    
6. Debemos instalar logstash y configurarlo para poder correr el servicio asociado a `winlogbeat`

## Instalando `logstash`

1. Descargamos `logstash`, descomprimimos la carpeta y la guardamos en `C:\`. 
2. Ingresamos a la carpeta `C:\logstash-8.13.4\config` y seteamos el archivo de configuración de `logstash` que es `logstash.yml`:
    
    ```bash
    path.data: C:/logstash-8.13.4/data
    pipeline.workers: 2
    pipeline.batch.size: 125
    config.reload.automatic: true
    http.host: "127.0.0.1"
    http.port: 9600-9700
    ```
3. En la misma carpeta `C:\logstash-8.13.4\config`, abrimos el archivo de configuración pipeline de `logstash` que es `logstash-sample.conf`. Veamos que se separa en un apartado de `input` y otro de `output`. En el primero se especifica de dónde proviene la información y en el segundo a quién debemos enviársela.
  
    La siguiente configuración es la utilizada para la EC2 Instancia de Windows presente en AWS:
        

        input {
          beats {
            port => 5044
            type => "windows"
          }
        }

        output {
          elasticsearch {
            hosts => ["http://10.1.102.178:9200", "http://10.1.103.227:9200"]
            index => "%{[type]}-%{+YYYY.MM.dd}"
          }
        }


    La siguiente configuración es una de las posibles a utilizar en el ambiente local:
        
        input {
          beats {
            port => 5044
          }
        }

        filter {
          if [event_data] {
            mutate {
              rename => { "[event_data][param1]" => "message" }
            }
          }
          date {
            match => [ "timestamp" , "dd/MMM/yyyy:HH:mm:ss Z" ]
          }
        }

        output {
            if [@metadata][pipeline] {
              elasticsearch {
                hosts => ["http://localhost:9200"]
                manage_template => false
                index => "%{[@metadata][beat]}-%{[@metadata][version]}" 
                action => "create" 
                pipeline => "%{[@metadata][pipeline]}" 
                user => "johndoe"
                password => "123456"   
              }
            } else {
              elasticsearch {
                hosts => ["http://localhost:9200"]
                manage_template => false
                index => "%{[@metadata][beat]}-%{[@metadata][version]}" 
                action => "create"
                user => "johndoe"
                password => "123456" 
              }
            }
        }

4. Descargamos NSSM de la página:
    
    [NSSM - the Non-Sucking Service Manager](https://nssm.cc/download)
    
5. Extraemos el archivo `nssm.exe` de la carpeta  `nssm-<version>\win64\nssm.exe` y lo ubicamos en `C:\logstash-8.13.4\bin\`.
   
6. Abrimos una terminal como administrador y balidamos el archivo de configuración del pipeline corriendo el siguiente comando:
    
    ```bash
    C:\logstash-8.13.4> .\bin\logstash.bat -t -f C:\logstash-8.13.4\config\logstash-sample.conf
    ```
    
    Nos tiene que devolver lo siguiente, específicamente con el `Configuration OK`:
    
    ```bash
    "Using bundled JDK: C:\logstash-8.13.4\jdk\bin\java.exe"
    C:/logstash-8.13.4/vendor/bundle/jruby/3.1.0/gems/concurrent-ruby-1.1.9/lib/concurrent-ruby/concurrent/executor/java_thread_pool_executor.rb:13: warning: method redefined; discarding old to_int
    ...
    [2024-05-20T18:39:14,819][INFO ][logstash.runner          ] Using config.test_and_exit mode. Config Validation Result: OK. Exiting Logstash
    ```
    
7. Abrimos una terminal como administradores y corremos el siguiente comando:
    
    ```bash
    C:\logstash-8.13.4 > .\bin\nssm.exe install logstash
    ```
    
8.  Corriendo el comando anterior aparece una ventana de `NSSM service installer`. En ella debemos especificar los siguientes parámetros:
    - Path (path a `logstash.bat`): `C:\logstash-8.13.4\bin\logstash.bat`
    - Startup Directory (path al directorio `bin`): `C:\logstash-8.13.4\bin`
    - Arguments: `-f C:\logstash-8.13.4\config\logstash-sample.conf`
        
        ![instaling-elk-on-windows-start-service](../img/instaling-elk-on-windows-nssm.png)
        
    
    Le damos a **Install service** para que se cree el servicio.
    
    
9.  Abrimos una terminal como administradores y corremos los servicios de `logstash` y `winlogbeat`:
    
    ```bash
    C:> Start-Service logstash
    C:> Start-Service winlogbeat
    ```